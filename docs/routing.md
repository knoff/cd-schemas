# Маршрутизация и Matrix Mapping

## Концепция

Внутри металлического корпуса используется статическая маршрутизация с возможностью пересчета карты сети (Self-Healing Configuration).

### Ограничения

- **Глубина:** Максимум 1 ретранслятор (1 Hop). `Coord -> Repeater -> Node`.
- **Адресация:** Логические ID (`HU_DEV_PUMP`) вместо MAC-адресов.

## Алгоритм Mapping (Калибровка)

Запускается в сервисном режиме.

1. **Silence:** Координатор переводит сеть в режим тишины.
2. **Roll Call:** Координатор по очереди запрашивает каждый узел отправить Broadcast PING.
3. **RSSI Report:** Все остальные узлы измеряют уровень сигнала и сообщают Координатору.
4. **Graph Calculation:** RPi строит матрицу связности.
   - Если `Direct RSSI > -75dBm` -> Используем прямую связь.
   - Если `Direct RSSI < -75dBm` -> Ищем соседа с лучшей суммой сигналов.
5. **Provisioning:** RPi генерирует и рассылает таблицу маршрутизации (`via_id`) каждому узлу.

## Структура таблицы маршрутизации

На стороне ESP32 таблица выглядит как простой массив:

```c
// routing_table[TARGET_ID] = NEXT_HOP_ID;
uint8_t routing_table[255];

// Пример: Чтобы отправить пакет Помпе (0x11), шли через Бойлер (0x10)
routing_table[0x11] = 0x10;
// Пример: Чтобы отправить Бойлеру (0x10), шли напрямую (0x00)
routing_table[0x10] = 0x00;
```
